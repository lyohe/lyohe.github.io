{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-05-31-go-encoding-csv/",
    "result": {"data":{"site":{"siteMetadata":{"title":"ここにかく"}},"markdownRemark":{"id":"64ed10d3-9571-5bcd-a04e-68bf46deb80c","excerpt":"ここ1ヶ月くらい空き時間で Go をやっている。 有名なチュートリアル A Tour of Go を二周したので、次の課題として言語標準のパッケージがどのように書かれているのかを調べることにした。理由としては、 Go は Go で書かれており標準パッケージのコードを読むとより Go…","html":"<p>ここ1ヶ月くらい空き時間で <a href=\"https://go.dev/\">Go</a> をやっている。</p>\n<p>有名なチュートリアル <a href=\"https://go-tour-jp.appspot.com/list\">A Tour of Go</a> を二周したので、次の課題として言語標準のパッケージがどのように書かれているのかを調べることにした。理由としては、 Go は Go で書かれており標準パッケージのコードを読むとより Go らしい書き方を身につけられそうと考えたため。</p>\n<p>その題材として <code class=\"language-text\">CSV</code> 形式の入出力を処理する <a href=\"https://pkg.go.dev/encoding/csv\">encoding/csv</a> のドキュメントとソースコードを読んだので、この記事にまとめておく。これを選んだのは CSV が自分が経理の仕事で慣れ親しんだフォーマットだったからで、それ以上の理由はない。</p>\n<p>ちなみに <a href=\"https://twitter.com/tenntenn/status/1528090919597375489\">twitter で質問したら io と error をお薦めされた</a>。この2つは回答者 tenntenn さんがお薦めされている理由に加えて頻出でもあるので、コードリーディングの題材としてよさそう。実際に encoding/csv の処理をデバッガ等で追っていくと最終的に io や error も現れてくる。</p>\n<h2 id=\"コードリーディングの前に\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E5%89%8D%E3%81%AB\" aria-label=\"コードリーディングの前に permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コードリーディングの前に</h2>\n<p>Go のコードを読む際にはこの動画が参考になった。</p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=X0tzCL5gqr8\">コードリーディングをしよう！ - tenntenn Conference 2022</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=cZJE-pK_uKs\">errorsパッケージを読む - tenntenn.go#1</a></li>\n</ul>\n<p>Go はコメントが充実していて読みやすい。ソースコードはこちら。</p>\n<p><a href=\"https://cs.opensource.google/go/go\">https://cs.opensource.google/go/go</a></p>\n<h2 id=\"csv-について\" style=\"position:relative;\"><a href=\"#csv-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"csv について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CSV について</h2>\n<p>コードを読む前に CSV について復習していく。</p>\n<p>一般的には <code class=\"language-text\">Comma-Separated Values</code> で略して <code class=\"language-text\">CSV</code> と呼ばれる。仕様は <a href=\"https://datatracker.ietf.org/doc/html/rfc4180\">RFC 4180</a> で定められているが、分類は Informational となっており、つまりは国際的に標準化されたものではなく単なる参考と言える。</p>\n<p>CSV はデータを受け渡すフォーマットとして幅広く利用されており、例えば Excel や Google Sheets などの表計算ソフトウェアで CSV を取り込んだり出力したりできる。私は長年に亘り経理の仕事をしていたのだが、何かと CSV にはお世話になった。</p>\n<p>例えば…</p>\n<ul>\n<li>銀行に総合振込（振込先と金額を記載したファイルを送り、一括で振込する処理）を指示するために銀行の指定する形式の CSV を専用の Web サイトからアップロードする</li>\n<li>財務会計ソフトに取り込む仕訳データを CSV で作る</li>\n<li>ERP などの業務システムから CSV 形式でデータを取得し、それを加工して資料を作る</li>\n</ul>\n<h2 id=\"rfc-4180-の概要\" style=\"position:relative;\"><a href=\"#rfc-4180-%E3%81%AE%E6%A6%82%E8%A6%81\" aria-label=\"rfc 4180 の概要 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RFC 4180 の概要</h2>\n<p>CSV の仕様はマネックス社の技術ブログで取り上げられているので、詳しく気になる方はそちらもご覧いただくのがよさそう。</p>\n<ul>\n<li><a href=\"https://blog.tech-monex.com/entry/2021/03/26/160000\">CSVの国際標準 RFC 4180 と JSONの国際標準 RFC 8259 をいまさら読みなおしてみた 前編</a> / <a href=\"https://blog.tech-monex.com/entry/2021/04/02/160000\">後編</a></li>\n</ul>\n<p>以下に特徴的な CSV の仕様についてまとめる。</p>\n<h3 id=\"レコード\" style=\"position:relative;\"><a href=\"#%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89\" aria-label=\"レコード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>レコード</h3>\n<p>CSV では、レコードは改行 <code class=\"language-text\">CRLF</code> によって区切られている。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aaa, bbb, ccc CRLF\naaa, bbb, ccc CRLF</code></pre></div>\n<p>このとき、最後の行には改行はなくても構わない。</p>\n<h3 id=\"ヘッダー\" style=\"position:relative;\"><a href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%BC\" aria-label=\"ヘッダー permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ヘッダー</h3>\n<p>最初のレコードをヘッダーとすることができる。ヘッダーレコードは<strong>2つ目以降のレコードと同数のフィールド</strong>を持ち、それぞれのフィールドに対応する名前を持つ。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">field_a,field_b,field_c CRLF\naaa,bbb,ccc CRLF\naaa,bbb,ccc CRLF</code></pre></div>\n<p>このとき、 MIME type でヘッダーの有無を指定すべきである。</p>\n<h3 id=\"区切り文字\" style=\"position:relative;\"><a href=\"#%E5%8C%BA%E5%88%87%E3%82%8A%E6%96%87%E5%AD%97\" aria-label=\"区切り文字 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>区切り文字</h3>\n<p>CSV という名前の通り、レコードとヘッダーはコンマ <code class=\"language-text\">,</code> で区切られる。</p>\n<p>ファイル全体に渡り、全てのレコードおよびヘッダーは同じ数のフィールドを持つべきである。スペースは無視されず、フィールドの一部として扱われる。</p>\n<p>各レコードの最後のフィールドにはコンマ <code class=\"language-text\">,</code> を<strong>つけてはいけない</strong>。</p>\n<p>つまり、下記は RFC 通りだが</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aaa,bbb,ccc</code></pre></div>\n<p>以下の書き方は RFC に反している。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aaa,bbb,ccc,</code></pre></div>\n<h3 id=\"二重引用符\" style=\"position:relative;\"><a href=\"#%E4%BA%8C%E9%87%8D%E5%BC%95%E7%94%A8%E7%AC%A6\" aria-label=\"二重引用符 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>二重引用符</h3>\n<p>各フィールドは二重引用符 <code class=\"language-text\">\"</code> で囲んでも良いし、囲まなくても良い。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"aaa\",\"bbb\",\"ccc\" CRLF\nxxx,yyy,zzz</code></pre></div>\n<p>ただし、フィールド内に改行 <code class=\"language-text\">CRLF</code>、二重引用符 <code class=\"language-text\">\"</code>、コンマ <code class=\"language-text\">,</code> を持つ場合は、フィールドを二重引用符 <code class=\"language-text\">\"</code> で囲むべきである。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"aaa\",\"b CRLF\nbb\",\"ccc\" CRLF\nxxx,yyy,zzz</code></pre></div>\n<p>上記の CSV は見た目は3行だが、1行目と2行目がひとつのレコードであり、レコード数は2となる。</p>\n<p>もし <code class=\"language-text\">\"</code> でフィールドを囲む場合、その内側では <code class=\"language-text\">\"</code> を使うべきではない。もし使う場合は、下記のように別の <code class=\"language-text\">\"</code> でエスケープする。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"aaa\",\"b\"\"bb\",\"ccc\"</code></pre></div>\n<p>まとめると、 CSV ファイルで使われる二重引用符 <code class=\"language-text\">\"</code> には以下3つの役割がある。</p>\n<ul>\n<li>フィールドの最初と最後につけることでフィールドを囲む</li>\n<li>フィールドの内容を表す（このとき、<strong>エスケープしなければならない</strong>）</li>\n<li>フィールドの内容を表す二重引用符をエスケープする</li>\n</ul>\n<p>Go の encoding/csv は利用者にこの RFC 4180 に準拠した入力を与えるよう期待している。ただし、 Reader や Writer の構造体に用意されているフィールドを<strong>明示的に書き換えることで RFC 4180 に反するような入出力が可能</strong>となる。</p>\n<h2 id=\"まず簡単に使ってみる\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%9A%E7%B0%A1%E5%8D%98%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"まず簡単に使ってみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まず簡単に使ってみる</h2>\n<p>ドキュメントやソースコードを読む前にとりあえず <code class=\"language-text\">encoding/csv</code> を使った簡単なプログラムを書いてみることにした。</p>\n<p>このような CSV に test.csv という名前をつけて読んでみる。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">従業員コード,名前,メールアドレス\n1,ヤマダ,yamada@example.com\n2,サトウ,sato@example.com\n3,スズキ,suzuki@example.com\n4,タナカ,tanaka@example.com\n5,ハシモト,hashimoto@example.com</code></pre></div>\n<p>このファイルをゼロから自分で解析する場合は先に挙げた仕様を満たすような実装を自分で書く必要があるが、 encoding/csv を使うと <code class=\"language-text\">NewReader</code> を呼んで返ってくる構造体 Reader を使うだけでよい。</p>\n<p><code class=\"language-text\">NewReader</code> が返す構造体を使って CSV を読むにはファイル全体を読む <code class=\"language-text\">ReadAll()</code> と1レコードずつ読む <code class=\"language-text\">Read()</code> の2種類の方法があるが、以下では Read() を使った。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"encoding/csv\"</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"io\"</span>\n\t<span class=\"token string\">\"os\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// CSV ファイルを開く</span>\n\tfile<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test.csv\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">defer</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// CSV ファイルを読む</span>\n\tcsvReader <span class=\"token operator\">:=</span> csv<span class=\"token punctuation\">.</span><span class=\"token function\">NewReader</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n\t\tline<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> csvReader<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">break</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>実行すると次のような出力を得る。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[従業員コード 名前 メールアドレス]\n[1 ヤマダ yamada@example.com]\n[2 サトウ sato@example.com]\n[3 スズキ suzuki@example.com]\n[4 タナカ tanaka@example.com]\n[5 ハシモト hashimoto@example.com]</code></pre></div>\n<p>この各行は Read() が返すスライス <code class=\"language-text\">[]string</code> である。 <code class=\"language-text\">Read()</code> ではなく <code class=\"language-text\">ReadAll()</code> を使うとファイル全体を二次元のスライス <code class=\"language-text\">[][]string</code> で返す。</p>\n<p>次に、より詳細な挙動を把握するためドキュメントを読んでみる。</p>\n<h2 id=\"ドキュメントとソースコードを読む\" style=\"position:relative;\"><a href=\"#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%A8%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"ドキュメントとソースコードを読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ドキュメントとソースコードを読む</h2>\n<p>encoding/csv には reader.go と writer.go の2つのファイルがある。それぞれ CSV を読み書きするための構造体や関数が書かれている。</p>\n<h3 id=\"readergo\" style=\"position:relative;\"><a href=\"#readergo\" aria-label=\"readergo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>reader.go</h3>\n<h4 id=\"type-reader\" style=\"position:relative;\"><a href=\"#type-reader\" aria-label=\"type reader permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Reader\">type Reader</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=99-174;bpv=0;bpt=0\">src</a></p>\n<p><code class=\"language-text\">Reader</code> は <code class=\"language-text\">NewReader()</code> 関数が返す構造体で、これを通じて RFC 4180 に準拠した入力を読み取ることができる。また、この構造体に定義されているフィールドを書き換えることで Reader の挙動をカスタマイズできる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// ソースコードには大量のコメントがついているが省略した</span>\n<span class=\"token comment\">// 大文字で始まるフィールドの値を書き換えることで、 RFC 4180 に反する入力を読み取ることができる</span>\n<span class=\"token keyword\">type</span> Reader <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tComma <span class=\"token builtin\">rune</span>\n\tComment <span class=\"token builtin\">rune</span>\n\tFieldsPerRecord <span class=\"token builtin\">int</span>\n\tLazyQuotes <span class=\"token builtin\">bool</span>\n\tTrimLeadingSpace <span class=\"token builtin\">bool</span>\n\tReuseRecord <span class=\"token builtin\">bool</span>\n\tTrailingComma <span class=\"token builtin\">bool</span>\n\tr <span class=\"token operator\">*</span>bufio<span class=\"token punctuation\">.</span>Reader\n\tnumLine <span class=\"token builtin\">int</span>\n\toffset <span class=\"token builtin\">int64</span>\n\trawBuffer <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>\n\trecordBuffer <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>\n\tfieldIndexes <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span>\n\tfieldPositions <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>position\n\tlastRecord <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>特徴的なフィールドは <code class=\"language-text\">Comment</code> で、 CSV 中にコメントを残しそのレコードを読み取り時に無視することができる。ちなみに RFC 4180 にはコメントについて特に記述はない。</p>\n<p>例えば先述の CSV で、以下のように <code class=\"language-text\">#</code> をつけたレコードをコメントアウトしたい（つまり、そのレコードを無視したい）とする。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">従業員コード,名前,メールアドレス\n1,ヤマダ,yamada@example.com\n2,サトウ,sato@example.com\n3,スズキ,suzuki@example.com\n4,タナカ,tanaka@example.com\n#メールアドレス変更予定につき一時的にコメントアウト　5,ハシモト,hashimoto@example.com</code></pre></div>\n<p>このとき、先程のプログラムで Comment フィールドにコメントを表す記号 <code class=\"language-text\">#</code> を入れておくとそのレコードを無視できる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">csvReader <span class=\"token operator\">:=</span> csv<span class=\"token punctuation\">.</span><span class=\"token function\">NewReader</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\ncsvReader<span class=\"token punctuation\">.</span>Comment <span class=\"token operator\">=</span> <span class=\"token string\">'#'</span></code></pre></div>\n<p>出力は以下のようになる。 <code class=\"language-text\">#</code> でコメントアウトしたレコードが除かれている。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[従業員コード 名前 メールアドレス]\n[1 ヤマダ yamada@example.com]\n[2 サトウ sato@example.com]\n[3 スズキ suzuki@example.com]\n[4 タナカ tanaka@example.com]</code></pre></div>\n<p>なお、コメントアウトできるのはレコードの先頭に記号をつけたときのみである。</p>\n<p>より詳しくはドキュメントの Example (Options) を参照。</p>\n<p><a href=\"https://pkg.go.dev/encoding/csv#example-Reader-Options\">https://pkg.go.dev/encoding/csv#example-Reader-Options</a></p>\n<p>他にも様々なフィールドがある。よく使いそうなのだと…</p>\n<ul>\n<li><code class=\"language-text\">Comma</code> rune: 区切り文字を設定する（つまりタブなど他の文字も区切りにできる）</li>\n<li><code class=\"language-text\">FieldsPerRecord</code> int: 各レコードに期待されるフィールド数を設定する（負の数字を入れるとチェックしないようにできる）</li>\n<li><code class=\"language-text\">TrimLeadingSpace</code> bool: 先頭の white space を無視する（区切り文字がスペースでも無視する）</li>\n</ul>\n<p>FieldsPerRecord に負の数字を入れると各行のフィールド数チェックをしないためレコードごとにフィールド数が異なる（つまり RFC 4180 に準拠しない） CSV を読み書きできるようになる。一見これは何のためにあるんだ？と思うかもしれないが、世の中には RFC 4180 に準拠しない CSV が平然と使われているので便利と言えるかもしれない。</p>\n<p>例えば「全銀フォーマット CSV」と呼ばれる銀行の総合振込に用いられるデータ形式では、レコードの種類を各レコード最初のフィールドで指定し、その種類ごとにフィールド数が異なるという仕様になっている。</p>\n<p>参考: <a href=\"https://www.rakuten-bank.co.jp/business/howto/pdf/h07_06_10.pdf\">楽天銀行 - 依頼ファイル仕様（全銀フォーマット CSV 形式）</a></p>\n<h4 id=\"newreader\" style=\"position:relative;\"><a href=\"#newreader\" aria-label=\"newreader permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#NewReader\">NewReader()</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=176-182;bpv=0;bpt=0\">src</a></p>\n<p>io.Reader を満たす引数（ファイルや標準入力）を受け取り、上述の構造体 <code class=\"language-text\">Reader</code> を作ってそのポインタを返すだけの関数。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">NewReader</span><span class=\"token punctuation\">(</span>r io<span class=\"token punctuation\">.</span>Reader<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Reader <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>Reader<span class=\"token punctuation\">{</span>\n\t\tComma<span class=\"token punctuation\">:</span> <span class=\"token string\">','</span><span class=\"token punctuation\">,</span>\n\t\tr<span class=\"token punctuation\">:</span>     bufio<span class=\"token punctuation\">.</span><span class=\"token function\">NewReader</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>区切り文字がデフォルトで <code class=\"language-text\">,</code> にされていることが分かる。</p>\n<p><code class=\"language-text\">bufio.NewReader()</code> は io.Reader 用のバッファをデフォルトのサイズ 4096 byte で作って返す関数。</p>\n<h4 id=\"readerfieldpos\" style=\"position:relative;\"><a href=\"#readerfieldpos\" aria-label=\"readerfieldpos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Reader.FieldPos\">(*Reader).FieldPos()</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=202-214;bpv=0;bpt=1\">src</a></p>\n<p>CSV 処理中のレコードとカラムのインデックスを返す関数。カラムのインデックスはバイト単位で数える。あまり使う場面は多くないが、ループで Read を呼び出す中で CSV の解析エラーをデバッグするのに便利そう。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Reader<span class=\"token punctuation\">)</span> <span class=\"token function\">FieldPos</span><span class=\"token punctuation\">(</span>field <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">,</span> column <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> field <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> field <span class=\"token operator\">>=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>fieldPositions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"out of range index passed to FieldPos\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tp <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>r<span class=\"token punctuation\">.</span>fieldPositions<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">]</span>\n\t<span class=\"token keyword\">return</span> p<span class=\"token punctuation\">.</span>line<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>col\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これは Go 1.17 で追加された新しい関数で、その背景や使い方については以下の記事が詳しい。</p>\n<ul>\n<li><a href=\"https://future-architect.github.io/articles/20210811a/\">Future Tech Blog - Go1.17のencoding/csv</a></li>\n</ul>\n<p>次に示す <code class=\"language-text\">Read()</code> 関数が最後に返した string スライスのうち、引数で指定したバイト単位のインデックスを持つフィールドの先頭に対応する行と列の番号を返す。</p>\n<h4 id=\"readerread\" style=\"position:relative;\"><a href=\"#readerread\" aria-label=\"readerread permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Reader.Read\">(*Reader).Read()</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=184-200;bpv=0;bpt=0\">src</a></p>\n<p>構造体 <code class=\"language-text\">Reader</code> をポインタレシーバで受け取り csv を一行ずつ読んで結果を string のスライスで返す関数。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Reader<span class=\"token punctuation\">)</span> <span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>record <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>ReuseRecord <span class=\"token punctuation\">{</span>\n\t\trecord<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">readRecord</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>lastRecord<span class=\"token punctuation\">)</span>\n\t\tr<span class=\"token punctuation\">.</span>lastRecord <span class=\"token operator\">=</span> record\n\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\trecord<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">readRecord</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> record<span class=\"token punctuation\">,</span> err\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>コメントによると、この関数は常に non-nil のレコード（string のスライス）もしくは non-nil エラーのいずれか片方を返すが、もしフィールドの数が異なるレコードが存在する（RFC 4180 に反する）場合は読み取ったレコードと共に <code class=\"language-text\">ErrFieldCount</code> というエラーを返す。このとき、 Reader 構造体の FieldsPerRecord に負の数字（例えば -1）を設定しておくとこのエラーチェックを迂回できる。</p>\n<p>また、最後の行にたどり着くとレコードとしては nil を返し err として <code class=\"language-text\">io.EOF</code> を返すので、これをチェックしておけばファイルの最後まで読んだことを検知できる。</p>\n<p>これら <code class=\"language-text\">Reader</code> 構造体の各フィールドの設定に応じた実際の読み取り処理は <code class=\"language-text\">readRecord</code> という別の関数（とても長い）で行われている。</p>\n<h4 id=\"readrecord\" style=\"position:relative;\"><a href=\"#readrecord\" aria-label=\"readrecord permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>readRecord</h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=292-462\">src</a></p>\n<p><code class=\"language-text\">readRecord</code> は160行以上ある巨大な関数で、実際に csv を読み取る実装がほぼ全て含まれている。小文字で始まっているので、この関数をパッケージ外から呼ぶことはできない。つまり、パッケージ内部でのみ使われている。全部読んでいくのはしんどいが、コメントを追っていけば処理の流れはわかりやすい。</p>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=293-296\">L293-296</a> 区切り文字とコメントに使う文字は異なる文字でなければならない。</p>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=297-315\">L297-315</a>: <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=246-277\">readLine</a> で bufio の ReadSlice を呼び、区切り文字までのバイト列を読み込む。このとき <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=278-285\">lengNL</a> と <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=286-291\">nextRune</a> を使って行頭にコメントがあるレコードや空のレコードを読み飛ばしている。</p>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=316-433\">L316-433</a>: 読み込んだレコードに対して、 Reader 構造体のフィールドに応じた処理をしていく。このときレコードの中身は Reader 構造体の <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=158-162;bpv=0;bpt=1\">recordBuffer</a> フィールドにまとめて <code class=\"language-text\">[]byte</code> で書き込まれ、各フィールド終了位置のインデックスは <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=164-166;bpv=0;bpt=1\">fieldIndexes</a> に <code class=\"language-text\">[]int</code> で、どのバイトまで読んだかは <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=168-170\">fieldPositions</a> に行と列をそれぞれ int で持つ type <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=223-226\">position</a> のスライスとして書き込まれる。</p>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=434-447\">L434-447</a>: recordBuffer への読み込みが一通り終わったら、それを fieldIndexes に記録したインデックス毎に区切って <code class=\"language-text\">[]string</code> に変換する。</p>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=448-460\">L448-460</a>: 最後に Reader 構造体の FieldsPerRecord が正の数であるときに各レコードのフィールド数が同じかどうかをチェックする。デフォルト値は最初に読み取ったレコードのフィールド数となる。読み取り前に負の値を設定しておけばこのフィールド数チェックを迂回できる。</p>\n<p>この関数で <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=325;bpv=0;bpt=1\">L325</a> 以降のような長い for 文を書くときにラベルをつけて break や continue できるのを知った。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">parseField<span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 数十行のクソ長い処理</span>\n      <span class=\"token keyword\">break</span> parseField\n    <span class=\"token comment\">// 数十行のクソ長い処理</span>\n      <span class=\"token keyword\">continue</span> parseField\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>ループの行数が多くなると <code class=\"language-text\">break</code> や <code class=\"language-text\">continue</code> が指す先が分かりにくくなるので、これは便利そう。</p>\n<h3 id=\"writergo\" style=\"position:relative;\"><a href=\"#writergo\" aria-label=\"writergo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>writer.go</h3>\n<p>reader.go に比べると writer.go は行数も半分以下で読みやすい。</p>\n<h4 id=\"type-writer\" style=\"position:relative;\"><a href=\"#type-writer\" aria-label=\"type writer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Writer\">type Writer</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=15-34;bpv=0;bpt=1\">src</a></p>\n<p>Reader と同様に Comma フィールドで区切り文字を書き換えることができる。UseCRLF が true の場合、Writer は各出力行の最後に <code class=\"language-text\">\\n</code> の代わりに <code class=\"language-text\">\\rn</code> を出力する。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> Writer <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tComma   <span class=\"token builtin\">rune</span> <span class=\"token comment\">// Field delimiter (set to ',' by NewWriter)</span>\n\tUseCRLF <span class=\"token builtin\">bool</span> <span class=\"token comment\">// True to use \\r\\n as the line terminator</span>\n\tw       <span class=\"token operator\">*</span>bufio<span class=\"token punctuation\">.</span>Writer\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意点として、 Writer を使って CSV に書き込んだ後に Flush() 関数を呼ばなければならない。</p>\n<p>詳しくは <a href=\"https://pkg.go.dev/encoding/csv#example-Writer\">example</a> を参照。</p>\n<h4 id=\"newwriter\" style=\"position:relative;\"><a href=\"#newwriter\" aria-label=\"newwriter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#NewWriter\">NewWriter()</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=36-42\">src</a></p>\n<p>io.Writer インターフェイスを満たす引数を受け取って Writer 構造体を返す関数。この引数が Write する先になるので、 <code class=\"language-text\">os.Stdout</code> を指定すれば標準出力できる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// NewWriter returns a new Writer that writes to w.</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">NewWriter</span><span class=\"token punctuation\">(</span>w io<span class=\"token punctuation\">.</span>Writer<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Writer <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>Writer<span class=\"token punctuation\">{</span>\n\t\tComma<span class=\"token punctuation\">:</span> <span class=\"token string\">','</span><span class=\"token punctuation\">,</span>\n\t\tw<span class=\"token punctuation\">:</span>     bufio<span class=\"token punctuation\">.</span><span class=\"token function\">NewWriter</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"writerwrite\" style=\"position:relative;\"><a href=\"#writerwrite\" aria-label=\"writerwrite permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Writer.Write\">(*Writer).Write()</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=44-119\">src</a></p>\n<p>CSV のレコード1行（つまり各フィールドのスライス）を <code class=\"language-text\">[]string</code> で受け取り、フィールドの数だけループして Writer 構造体が示すバッファに書き込む関数。</p>\n<p>次の順序で処理する。</p>\n<ul>\n<li><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=60-67\">L60-67</a>: 引用符で囲む必要があるかどうかをチェックする\n<ul>\n<li>必要なければそのまま書いて次のフィールドへ continue</li>\n</ul>\n</li>\n<li><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=69-71\">L69-71</a>: 引用符が必要な場合はまず最初の <code class=\"language-text\">\"</code> を書く</li>\n<li><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=72-111\">L72-111</a>: フィールドの長さが 0 でなければ特殊文字（改行 <code class=\"language-text\">\\r</code> <code class=\"language-text\">\\n</code> と引用符 <code class=\"language-text\">\"</code>）を数える\n<ul>\n<li>特殊文字の中身と Writer 構造体の UseCRLF フィールドの設定に応じて特殊文字を書き込む\n<ul>\n<li>例えば UseCRLF が true なら、 <code class=\"language-text\">\\n</code> に対して <code class=\"language-text\">\\r\\n</code> を書く</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=113-117\">L113-117</a>: UseCRLF が true なら各レコードの末尾に <code class=\"language-text\">\\r\\n</code> を、 false なら <code class=\"language-text\">\\n</code> を書く</li>\n</ul>\n<p>実際に Write を使って CSV に書き込むコードは以下のようになる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"encoding/csv\"</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"os\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  records <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"first_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"last_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"Rob\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Pike\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rob\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"Ken\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Thompson\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ken\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"Robert\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Griesemer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"gri\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  file<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"users.csv\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// CSV のファイル名</span>\n  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n  \tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  csvWriter <span class=\"token operator\">:=</span> csv<span class=\"token punctuation\">.</span><span class=\"token function\">NewWriter</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> record <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> records <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ここで Writer 構造体のバッファにデータを書き込む</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> csvWriter<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n      log<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalln</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error writing record to csv:\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// バッファのデータを io.Writer （ここでは CSV ファイル）に書き込む関数</span>\n  csvWriter<span class=\"token punctuation\">.</span><span class=\"token function\">Flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> csvWriter<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意点として、（デバッガで動かすとすぐに分かるが）Write は内部的には bufio のバッファに入力をコピーしているだけなので、これを呼んだ後に後述の Flush を呼ばないと何も書き込まれない。</p>\n<p>bufio のコードを読む限りではバッファに空きがないときは Flush するようになっているようで、よくできた仕組みだと思った。</p>\n<h4 id=\"writerflush\" style=\"position:relative;\"><a href=\"#writerflush\" aria-label=\"writerflush permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://pkg.go.dev/encoding/csv#Writer.Flush\">(*Writer).Flush</a></h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=121-125\">src</a></p>\n<p>encoding/csv の Write 関数は bufio のバッファに書き込む。これを io.Writer に渡すにはこの Flush 関数を呼ばなければならない。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Flush writes any buffered data to the underlying io.Writer.</span>\n<span class=\"token comment\">// To check if an error occurred during the Flush, call Error.</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span>Writer<span class=\"token punctuation\">)</span> <span class=\"token function\">Flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tw<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">.</span><span class=\"token function\">Flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>内部ではこのように <a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/bufio/bufio.go;l=621-643\">bufio の Flush</a> を呼んでいるだけ。 bufio の方ではバッファと io.Writer を持つ構造体があって、それを使って io.Writer に書き込んでいる。</p>\n<p>繰り返しになるが Write を呼んだ後に Flush を呼ばないと書き込まれないので注意する。</p>\n<h4 id=\"fieldneedsquote\" style=\"position:relative;\"><a href=\"#fieldneedsquote\" aria-label=\"fieldneedsquote permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fieldNeedsQuote</h4>\n<p><a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/writer.go;l=145-181\">src</a></p>\n<p>CSV のレコード中のフィールドを1つ受け取り、それが引用符で囲まれなければならないかどうかを bool で返す関数。Write 関数から呼び出される。小文字で始まっていることから分かるように、パッケージ内部でのみ使う。</p>\n<p>フィールドが以下の5通りのいずれかを満たすとき、この関数は <code class=\"language-text\">true</code> を返す。</p>\n<ul>\n<li>引用符 <code class=\"language-text\">\"</code> を含む</li>\n<li>改行 <code class=\"language-text\">\\r</code> もしくは <code class=\"language-text\">\\n</code>を含む</li>\n<li>コンマ <code class=\"language-text\">,</code> 、または Writer 構造体の Comma フィールドで設定された区切り文字を含む</li>\n<li><code class=\"language-text\">\\.</code></li>\n<li>スペースで始まる</li>\n</ul>\n<p>なお、空文字列に対しては <code class=\"language-text\">false</code> を返す。つまり、空文字列は引用符で囲まなくてもよい（Go 1.4 以降）。これは Excel や Google Sheets が CSV を作る際の挙動と合わせるため。</p>\n<h2 id=\"感想\" style=\"position:relative;\"><a href=\"#%E6%84%9F%E6%83%B3\" aria-label=\"感想 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>感想</h2>\n<p>読んでみて非常に面白かったので感想を残しておく。</p>\n<p>Go に限らない一般的なプログラミング手法について、および Go の読み書きについて大変参考になった。</p>\n<h3 id=\"go-に限らない一般的なプログラミング手法\" style=\"position:relative;\"><a href=\"#go-%E3%81%AB%E9%99%90%E3%82%89%E3%81%AA%E3%81%84%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E6%89%8B%E6%B3%95\" aria-label=\"go に限らない一般的なプログラミング手法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Go に限らない一般的なプログラミング手法</h3>\n<p>まず有用かつ単純なコメントが多いため、初めて読む人間にとっても関数や構造体の振る舞いが分かりやすい。</p>\n<p><a href=\"https://lyohe.github.io/2022-05-21-readable-code/\">最近リーダブルコードを読んだ</a>のだが、 encoding/csv のコメントを読んでいて「これリーダブルコードじゃん」と思った。むしろリーダブルコードがプログラマーの経験知をまとめた著作なので、順序としては逆かもしれない。皆さんもぜひ読んでみてください。</p>\n<p>また、関数の分割方法についても参考になった。encoding/csv ではパッケージの利用者が呼び出す関数はせいぜい数行で、それらの具体的な処理の大部分は内部でしか使わない関数に切り分けられている。例えば RFC に沿って CSV を読む処理の実装はほぼ <code class=\"language-text\">readLine</code> という巨大な関数に書かれている。</p>\n<p>Go では名前が大文字で始まる関数はパッケージ外部から呼び出すことができ、小文字から始まる関数は外部から呼び出せない。この仕様は Go 独特だが、他の言語にも違う記法で同等のことを実現する仕組みはあると思う。利用者が詳しく知る必要がない内部実装を <code class=\"language-text\">readRecord</code> など内部でのみ使う関数にまとめておいて、大文字で始まるつまり外部から使える関数では<strong>それを呼び出す状況や引数をコントロールする</strong>というのは、プログラムを読み書きしやすくする上で非常に合理的だと思った。</p>\n<p>例えば Read 関数では Reader 構造体の ReuseRecord フィールドの値によって readRecord を呼び出す引数を変えている（<a href=\"https://cs.opensource.google/go/go/+/3474cd4eee82ac442618391f8bc4a70d7b1cb65a:src/encoding/csv/reader.go;l=184-200\">src</a>）。</p>\n<p>これもリーダブルコードの「コードの再構成」で読んだ話に近い。プロとして長年プログラミングをやっている人にとっては当然のことかもしれないが、こうすると読みやすくなるな〜と実感できて良かった。</p>\n<h3 id=\"go-の書き方\" style=\"position:relative;\"><a href=\"#go-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\" aria-label=\"go の書き方 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Go の書き方</h3>\n<p>Go の特徴？として、エラー処理が挙げられる。</p>\n<p>Go では（例えば Java や JavaScript 等で可能なように）例外を投げて try-catch で捕捉するようなエラー処理をせず、原則的には関数から複数の値（処理結果と error）を返すように実装し、呼び出し側で以下のように if 文で分岐することでエラー処理をすることが多い。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">line<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> csvReader<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Read() は正常に処理を行ったとき err が nil になる</span>\n  <span class=\"token comment\">// この条件分岐では err が nil ではない、つまりエラーがあるときの処理を書く</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これはコードが冗長になる一方で、メリットもある。<a href=\"https://go.dev/doc/faq#exceptions\">Go の Frequently Asked Questions (FAQ) によれば</a>、</p>\n<ul>\n<li>例外を制御機構に結びつけるとコードが複雑になってしまうので、それを防ぐ</li>\n<li>エラー処理すべきところを例外で処理させないよう促す</li>\n</ul>\n<p>という意図があるようだ。</p>\n<blockquote>\n<p>We believe that coupling exceptions to a control structure, as in the try-catch-finally idiom, results in convoluted code. It also tends to encourage programmers to label too many ordinary errors, such as failing to open a file, as exceptional.</p>\n</blockquote>\n<p>他にも開発者がエラー処理について書いた記事として以下が挙げられる。</p>\n<p><a href=\"https://go.dev/blog/error-handling-and-go\">https://go.dev/blog/error-handling-and-go</a></p>\n<blockquote>\n<p>In Go, error handling is important. The language’s design and conventions encourage you to explicitly check for errors where they occur (as distinct from the convention in other languages of throwing exceptions and sometimes catching them).</p>\n</blockquote>\n<p>過去には様々な議論があると思うので、Go の特徴的な仕様に触れる度に深掘りしていきたい。</p>\n<p>とにかく、 Go では処理結果と error を返して呼び出し側で責任持ってその処理をする、プロセス自体は止めない、止める場合は panic を使うがあくまで例外的な状況、という方針が推奨されている。</p>\n<h2 id=\"次の課題\" style=\"position:relative;\"><a href=\"#%E6%AC%A1%E3%81%AE%E8%AA%B2%E9%A1%8C\" aria-label=\"次の課題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>次の課題</h2>\n<p>全銀の総合振込フォーマットを検証するパッケージとそれを使ったコマンドラインツールを作る。</p>\n<p>自分もプログラミングの傍ら？経理をやっていて、普段は過去のデータをコピペして作っているのだが、より頭を使わずに処理したいため。</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E5%89%8D%E3%81%AB\">コードリーディングの前に</a></p>\n</li>\n<li>\n<p><a href=\"#csv-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">CSV について</a></p>\n</li>\n<li>\n<p><a href=\"#rfc-4180-%E3%81%AE%E6%A6%82%E8%A6%81\">RFC 4180 の概要</a></p>\n<ul>\n<li><a href=\"#%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89\">レコード</a></li>\n<li><a href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%BC\">ヘッダー</a></li>\n<li><a href=\"#%E5%8C%BA%E5%88%87%E3%82%8A%E6%96%87%E5%AD%97\">区切り文字</a></li>\n<li><a href=\"#%E4%BA%8C%E9%87%8D%E5%BC%95%E7%94%A8%E7%AC%A6\">二重引用符</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%81%BE%E3%81%9A%E7%B0%A1%E5%8D%98%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\">まず簡単に使ってみる</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%A8%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%AA%AD%E3%82%80\">ドキュメントとソースコードを読む</a></p>\n<ul>\n<li>\n<p><a href=\"#readergo\">reader.go</a></p>\n<ul>\n<li><a href=\"#type-reader\">type Reader</a></li>\n<li><a href=\"#newreader\">NewReader()</a></li>\n<li><a href=\"#readerfieldpos\">(*Reader).FieldPos()</a></li>\n<li><a href=\"#readerread\">(*Reader).Read()</a></li>\n<li><a href=\"#readrecord\">readRecord</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#writergo\">writer.go</a></p>\n<ul>\n<li><a href=\"#type-writer\">type Writer</a></li>\n<li><a href=\"#newwriter\">NewWriter()</a></li>\n<li><a href=\"#writerwrite\">(*Writer).Write()</a></li>\n<li><a href=\"#writerflush\">(*Writer).Flush</a></li>\n<li><a href=\"#fieldneedsquote\">fieldNeedsQuote</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%84%9F%E6%83%B3\">感想</a></p>\n<ul>\n<li><a href=\"#go-%E3%81%AB%E9%99%90%E3%82%89%E3%81%AA%E3%81%84%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E6%89%8B%E6%B3%95\">Go に限らない一般的なプログラミング手法</a></li>\n<li><a href=\"#go-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\">Go の書き方</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%AC%A1%E3%81%AE%E8%AA%B2%E9%A1%8C\">次の課題</a></p>\n</li>\n</ul>","frontmatter":{"title":"Go の encoding/csv を読んだ話","date":"June 17, 2022","description":null}},"previous":{"fields":{"slug":"/2022-05-21-readable-code/"},"frontmatter":{"title":"リーダブルコードを読んだ話"}},"next":null},"pageContext":{"id":"64ed10d3-9571-5bcd-a04e-68bf46deb80c","previousPostId":"5838c871-27c2-5962-be51-d24c938f0daa","nextPostId":null}},
    "staticQueryHashes": ["1445466728","2841359383"]}