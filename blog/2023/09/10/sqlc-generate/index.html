<!DOCTYPE html><html lang="ja" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v4.4.11"><!-- Favicon --><link rel="icon" href="/favicon.ico" type="image/x-icon"><!-- Font preloads --><link rel="preload" href="/fonts/NotoSansJP-Regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/NotoSansJP-Bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://lyohe.github.io/blog/2023/09/10/sqlc-generate/"><!-- Primary Meta Tags --><title>sqlc generate は何をしているのかメモ</title><meta name="title" content="sqlc generate は何をしているのかメモ"><meta name="description" content="sqlc generate は何をしているのかメモ"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://lyohe.github.io/blog/2023/09/10/sqlc-generate/"><meta property="og:title" content="sqlc generate は何をしているのかメモ"><meta property="og:description" content="sqlc generate は何をしているのかメモ"><meta property="og:image" content="https://lyohe.github.io/2023/09/10/sqlc.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lyohe.github.io/blog/2023/09/10/sqlc-generate/"><meta property="twitter:title" content="sqlc generate は何をしているのかメモ"><meta property="twitter:description" content="sqlc generate は何をしているのかメモ"><meta property="twitter:image" content="https://lyohe.github.io/2023/09/10/sqlc.png"><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Noto Sans JP;src:url(/fonts/NotoSansJP-Regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Noto Sans JP;src:url(/fonts/NotoSansJP-Bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Noto Sans JP,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:16px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:2em}h2{font-size:1.8em}h3{font-size:1.6em}h4{font-size:1.4em}h5{font-size:1.2em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>ここにかく</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blog </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://twitter.com/rtsudal" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow me on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/lyohe" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to my GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/2023/09/10/sqlc.png" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2023-09-09T15:00:00.000Z"> 2023年9月10日 </time>  </div> <h1 data-astro-cid-bvzihdzo>sqlc generate は何をしているのかメモ</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>[2023-09-11 追記] 以下のブログの方が分かりやすいので、そちらを読むことをお勧めします。</p>
<ul>
<li><a href="https://orisano.hatenablog.com/entry/2023/09/11/232741">sqlc internals - 薄いブログ</a></li>
</ul>
<hr>
<p>最近、個人開発で Go のアプリケーションからデータベースを操作するために <a href="https://github.com/sqlc-dev/sqlc">sqlc</a> を使っている。sqlc は SQL で書いたスキーマのファイルから <code>sqlc generate</code> コマンド一つで Go の構造体を、クエリのファイルから型安全な Go の SQL クライアントを生成することができる。<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p>私は普段の仕事で ORM が提供するメソッドやクエリビルダを使って SQL を組み立てている。ORM は便利ではあるが、最終的に実行される SQL は可読性が低くてデバッグしづらいことが多い。そのため「最初から SQL を書けば良いのでは…？」と考えるようになり、初めて sqlc を見たとき自分の好みに合うツールと確信した。</p>
<p>使い方は簡単で便利なのだが、どうやって <code>sqlc generate</code> コマンドで Go のコードを生成しているのか想像がつかなかったのでコードを読んでみることにした。対象バージョンは <a href="https://github.com/sqlc-dev/sqlc/tree/98ef71db35880c939855b971a8be979746085283">v1.20.0</a> とする。</p>
<h2 id="sqlc-の使い方">sqlc の使い方</h2>
<p>まずは sqlc の使い方をおさらいする。</p>
<ol>
<li>スキーマとクエリを SQL で書く</li>
<li><code>sqlc generate</code> コマンドで Go のメソッドと構造体を生成する</li>
<li>生成したメソッドと構造体を自分のアプリケーションから呼び出す</li>
</ol>
<p>以下のようなディレクトリ構成で簡単なアプリケーションを作る。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>.</span></span>
<span class="line"><span>├── database</span></span>
<span class="line"><span>│   ├── queries</span></span>
<span class="line"><span>│   │   └── queries.sql</span></span>
<span class="line"><span>│   └── schema</span></span>
<span class="line"><span>│       └── schema.sql</span></span>
<span class="line"><span>├── generated</span></span>
<span class="line"><span>│   ├── db.go</span></span>
<span class="line"><span>│   ├── models.go</span></span>
<span class="line"><span>│   └── queries.sql.go</span></span>
<span class="line"><span>├── main.go</span></span>
<span class="line"><span>└── sqlc.yaml</span></span></code></pre>
<p>以下では例として PostgreSQL を使用するが、sqlc は MySQL でも SQLite でも使える。</p>
<p>まずは SQL でスキーマを書く。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> TABLE</span><span style="color:#B392F0"> IF</span><span style="color:#F97583"> NOT</span><span style="color:#F97583"> EXISTS</span><span style="color:#9ECBFF"> "authors"</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">  "id"</span><span style="color:#F97583">   BIGSERIAL</span><span style="color:#F97583"> PRIMARY KEY</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  "name"</span><span style="color:#F97583"> text</span><span style="color:#F97583">      NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  "bio"</span><span style="color:#F97583">  text</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>次に SQL でデータベースを操作するクエリを書く。このとき、<strong>メソッド名と適用するコマンドをコメントで書いておく</strong>。使えるコマンドは公式ドキュメントに記載されている。</p>
<p><a href="https://docs.sqlc.dev/en/stable/reference/query-annotations.html">https://docs.sqlc.dev/en/stable/reference/query-annotations.html</a></p>
<p><code>:one</code> や <code>:many</code> 等のコマンドによってクエリを実行するメソッドの返り値の型を定義することができる。<code>:batchMany</code> などで PostgreSQL のドライバー pgx を使ってバッチ処理をすることもできる。業務システムで大量のデータをバッチ処理する際には有用そうだ。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">-- name: GetAuthor :one</span></span>
<span class="line"><span style="color:#F97583">SELECT</span><span style="color:#F97583"> *</span><span style="color:#F97583"> FROM</span><span style="color:#E1E4E8"> authors</span></span>
<span class="line"><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> LIMIT</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- name: ListAuthors :many</span></span>
<span class="line"><span style="color:#F97583">SELECT</span><span style="color:#F97583"> *</span><span style="color:#F97583"> FROM</span><span style="color:#E1E4E8"> authors</span></span>
<span class="line"><span style="color:#F97583">ORDER BY</span><span style="color:#F97583"> name</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- name: CreateAuthor :one</span></span>
<span class="line"><span style="color:#F97583">INSERT INTO</span><span style="color:#E1E4E8"> authors (</span></span>
<span class="line"><span style="color:#F97583">  name</span><span style="color:#E1E4E8">, bio</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">VALUES</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">  $</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, $</span><span style="color:#79B8FF">2</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">RETURNING </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- name: UpdateAuthor :one</span></span>
<span class="line"><span style="color:#F97583">UPDATE</span><span style="color:#E1E4E8"> authors</span></span>
<span class="line"><span style="color:#F97583">  set</span><span style="color:#F97583"> name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> $</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  bio </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $</span><span style="color:#79B8FF">3</span></span>
<span class="line"><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $</span><span style="color:#79B8FF">1</span></span>
<span class="line"><span style="color:#E1E4E8">RETURNING </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- name: DeleteAuthor :exec</span></span>
<span class="line"><span style="color:#F97583">DELETE</span><span style="color:#F97583"> FROM</span><span style="color:#E1E4E8"> authors</span></span>
<span class="line"><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>sqlc では SQL や生成する Go ファイルの配置先を設定するファイルを YAML や JSON で書く。</p>
<p><a href="https://docs.sqlc.dev/en/stable/reference/config.html">https://docs.sqlc.dev/en/stable/reference/config.html</a></p>
<p>例えば “./database/” 以下の SQL ファイルでできたスキーマとクエリを “tutorial” というパッケージ名で “./generated/” 以下に出力する設定は YAML で以下のように書くことができる。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#85E89D">version</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"2"</span></span>
<span class="line"><span style="color:#85E89D">sql</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">engine</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"postgresql"</span></span>
<span class="line"><span style="color:#85E89D">    queries</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./database/queries/queries.sql"</span></span>
<span class="line"><span style="color:#85E89D">    schema</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"/database/schema/schema.sql"</span></span>
<span class="line"><span style="color:#85E89D">    gen</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      go</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        package</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"tutorial"</span></span>
<span class="line"><span style="color:#85E89D">        out</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./generated"</span></span></code></pre>
<p>ここまでの準備ができたら sqlc コマンドを sqlc の設定ファイルがあるディレクトリで実行する。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> sqlc</span><span style="color:#9ECBFF"> generate</span></span></code></pre>
<p>これによりデータベースのクライアントとなる Go のメソッドと構造体を生成できる。ここからは実際に何が生成されたのかを見ていく。</p>
<p>まず <code>db.go</code> として、データベースへの接続やトランザクション管理などデータベース操作に関連したメソッドが自動生成されている。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Code generated by sqlc. DO NOT EDIT.</span></span>
<span class="line"><span style="color:#6A737D">// versions:</span></span>
<span class="line"><span style="color:#6A737D">//   sqlc v1.20.0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> tutorial</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">context</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">database/sql</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> DBTX</span><span style="color:#F97583"> interface</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">	ExecContext</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">...interface</span><span style="color:#E1E4E8">{}) (</span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">	PrepareContext</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Stmt</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">	QueryContext</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">...interface</span><span style="color:#E1E4E8">{}) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Rows</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">	QueryRowContext</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">...interface</span><span style="color:#E1E4E8">{}) </span><span style="color:#F97583">*</span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Row</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> New</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">db</span><span style="color:#B392F0"> DBTX</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">{db: db}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Queries</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	db </span><span style="color:#B392F0">DBTX</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">WithTx</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">tx</span><span style="color:#F97583"> *</span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Tx</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		db: tx,</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>ここで <code>DBTX</code> インターフェイスが定義する ExecContext などのメソッドは Go の <a href="https://pkg.go.dev/database/sql">database/sql</a> パッケージ内の複数の型で実装されている。</p>
<p>次に、<code>models.go</code> としてデータベースのスキーマに沿った構造体が生成されている。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Code generated by sqlc. DO NOT EDIT.</span></span>
<span class="line"><span style="color:#6A737D">// versions:</span></span>
<span class="line"><span style="color:#6A737D">//   sqlc v1.20.0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> tutorial</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">database/sql</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Author</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	ID   </span><span style="color:#F97583">int64</span></span>
<span class="line"><span style="color:#E1E4E8">	Name </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	Bio  </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>これは sqlc で自動生成したデータの取得・操作メソッドが返す値の型として自分のアプリケーションで使うことができる。</p>
<p>ここで生成されるファイルは設定ファイルやプラグインでカスタマイズできる。例えば先述の config ファイルで <code>emit_json_tags</code> を true にすると、以下のように構造体へ json タグを付与することができる。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Author</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	ID   </span><span style="color:#F97583">int64</span><span style="color:#9ECBFF">          `json:"id"`</span></span>
<span class="line"><span style="color:#E1E4E8">	Name </span><span style="color:#F97583">string</span><span style="color:#9ECBFF">         `json:"name"`</span></span>
<span class="line"><span style="color:#E1E4E8">	Bio  </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span><span style="color:#9ECBFF"> `json:"bio"`</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>このタグはコード上ではただのコメントに過ぎないが、リフレクションを活用するパッケージを介して構造体のメタデータとして使うことができる。例えば <a href="https://pkg.go.dev/encoding/json">encoding/json</a> では JSON のフィールド名を構造体のフィールドにマッピングすることができる。これにより、外部から受け取った JSON をスムーズに Go の構造体へ読み込むことが簡単になる。</p>
<p>最後に <code>queries.sql.go</code> を見てみる。ここにはデータを取得・操作するメソッドが生成されている。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Code generated by sqlc. DO NOT EDIT.</span></span>
<span class="line"><span style="color:#6A737D">// versions:</span></span>
<span class="line"><span style="color:#6A737D">//   sqlc v1.20.0</span></span>
<span class="line"><span style="color:#6A737D">// source: queries.sql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> tutorial</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">context</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">database/sql</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> createAuthor </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: CreateAuthor :one</span></span>
<span class="line"><span style="color:#9ECBFF">INSERT INTO authors (</span></span>
<span class="line"><span style="color:#9ECBFF">  name, bio</span></span>
<span class="line"><span style="color:#9ECBFF">) VALUES (</span></span>
<span class="line"><span style="color:#9ECBFF">  $1, $2</span></span>
<span class="line"><span style="color:#9ECBFF">)</span></span>
<span class="line"><span style="color:#9ECBFF">RETURNING id, name, bio</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> CreateAuthorParams</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	Name </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	Bio  </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">CreateAuthor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">arg</span><span style="color:#B392F0"> CreateAuthorParams</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">Author</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	row </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">QueryRowContext</span><span style="color:#E1E4E8">(ctx, createAuthor, arg.Name, arg.Bio)</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> i </span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#E1E4E8">	err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> row.</span><span style="color:#B392F0">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.ID, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Name, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Bio)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> i, err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> deleteAuthor </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: DeleteAuthor :exec</span></span>
<span class="line"><span style="color:#9ECBFF">DELETE FROM authors</span></span>
<span class="line"><span style="color:#9ECBFF">WHERE id = $1</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">DeleteAuthor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">id</span><span style="color:#F97583"> int64</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	_, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">ExecContext</span><span style="color:#E1E4E8">(ctx, deleteAuthor, id)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> getAuthor </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: GetAuthor :one</span></span>
<span class="line"><span style="color:#9ECBFF">SELECT id, name, bio FROM authors</span></span>
<span class="line"><span style="color:#9ECBFF">WHERE id = $1 LIMIT 1</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">GetAuthor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">id</span><span style="color:#F97583"> int64</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">Author</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	row </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">QueryRowContext</span><span style="color:#E1E4E8">(ctx, getAuthor, id)</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> i </span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#E1E4E8">	err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> row.</span><span style="color:#B392F0">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.ID, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Name, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Bio)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> i, err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> listAuthors </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: ListAuthors :many</span></span>
<span class="line"><span style="color:#9ECBFF">SELECT id, name, bio FROM authors</span></span>
<span class="line"><span style="color:#9ECBFF">ORDER BY name</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">ListAuthors</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">) ([]</span><span style="color:#B392F0">Author</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	rows, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">QueryContext</span><span style="color:#E1E4E8">(ctx, listAuthors)</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	defer</span><span style="color:#E1E4E8"> rows.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> items []</span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> rows.</span><span style="color:#B392F0">Next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">		var</span><span style="color:#E1E4E8"> i </span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> rows.</span><span style="color:#B392F0">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.ID, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Name, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Bio); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		items </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(items, i)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> rows.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">(); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> rows.</span><span style="color:#B392F0">Err</span><span style="color:#E1E4E8">(); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> items, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> updateAuthor </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: UpdateAuthor :one</span></span>
<span class="line"><span style="color:#9ECBFF">UPDATE authors</span></span>
<span class="line"><span style="color:#9ECBFF">  set name = $2,</span></span>
<span class="line"><span style="color:#9ECBFF">  bio = $3</span></span>
<span class="line"><span style="color:#9ECBFF">WHERE id = $1</span></span>
<span class="line"><span style="color:#9ECBFF">RETURNING id, name, bio</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> UpdateAuthorParams</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	ID   </span><span style="color:#F97583">int64</span></span>
<span class="line"><span style="color:#E1E4E8">	Name </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	Bio  </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">UpdateAuthor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">arg</span><span style="color:#B392F0"> UpdateAuthorParams</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">Author</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	row </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">QueryRowContext</span><span style="color:#E1E4E8">(ctx, updateAuthor, arg.ID, arg.Name, arg.Bio)</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> i </span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#E1E4E8">	err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> row.</span><span style="color:#B392F0">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.ID, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Name, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Bio)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> i, err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>生成されたコードをよく見ると 2 ~ 3 個のブロックが 1 セットで生成されていることがわかる。</p>
<ol>
<li>SQL のクエリを格納する定数</li>
<li>（パラメータが複数ある場合）パラメータを示す型</li>
<li>クエリを実行するためのメソッド（Context と 2. を引数に取る）</li>
</ol>
<p>最初に書いた SQL は const で定数として定義されている。例えば authors テーブルに 1 レコードを追加する SQL を見ると…</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">-- name: CreateAuthor :one</span></span>
<span class="line"><span style="color:#F97583">INSERT INTO</span><span style="color:#E1E4E8"> authors (</span></span>
<span class="line"><span style="color:#F97583">  name</span><span style="color:#E1E4E8">, bio</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">VALUES</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">  $</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, $</span><span style="color:#79B8FF">2</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">RETURNING </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>SQL 部分は <code>*</code> がカラム名になっている以外は同じ。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> createAuthor </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `-- name: CreateAuthor :one</span></span>
<span class="line"><span style="color:#9ECBFF">INSERT INTO authors (</span></span>
<span class="line"><span style="color:#9ECBFF">  name, bio</span></span>
<span class="line"><span style="color:#9ECBFF">) VALUES (</span></span>
<span class="line"><span style="color:#9ECBFF">  $1, $2</span></span>
<span class="line"><span style="color:#9ECBFF">)</span></span>
<span class="line"><span style="color:#9ECBFF">RETURNING id, name, bio</span></span>
<span class="line"><span style="color:#9ECBFF">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> CreateAuthorParams</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	Name </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	Bio  </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">q </span><span style="color:#F97583">*</span><span style="color:#B392F0">Queries</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">CreateAuthor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">arg</span><span style="color:#B392F0"> CreateAuthorParams</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">Author</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	row </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> q.db.</span><span style="color:#B392F0">QueryRowContext</span><span style="color:#E1E4E8">(ctx, createAuthor, arg.Name, arg.Bio)</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> i </span><span style="color:#B392F0">Author</span></span>
<span class="line"><span style="color:#E1E4E8">	err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> row.</span><span style="color:#B392F0">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.ID, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Name, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">i.Bio)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> i, err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>実際にこれを使うには、生成したメソッドと構造体を自分のアプリケーションから呼び出す。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">	ctx </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> context.</span><span style="color:#B392F0">Background</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	db, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sql.</span><span style="color:#B392F0">Open</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"postgres"</span><span style="color:#E1E4E8">, os.</span><span style="color:#B392F0">Getenv</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"DATABASE_URL"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	defer</span><span style="color:#E1E4E8"> db.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	client </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> tutorial.</span><span style="color:#B392F0">New</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#E1E4E8">	newAuthor, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> client.</span><span style="color:#B392F0">CreateAuthor</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#B392F0">tutorial</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">CreateAuthorParams</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">		Name: </span><span style="color:#9ECBFF">"new author"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">		Bio: </span><span style="color:#B392F0">sql</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">NullString</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">			String: </span><span style="color:#9ECBFF">"new author bio"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">			Valid:  </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">		},</span></span>
<span class="line"><span style="color:#E1E4E8">	})</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<p>上記のように、</p>
<ol>
<li>SQL を書く</li>
<li>1 から Go の構造体とメソッドを自動生成する</li>
<li>2 を自分のアプリケーションから呼び出す</li>
</ol>
<p>という 3 step で簡単にデータベースを操作するプログラムを書くことができてとても便利なパッケージであることが分かる。</p>
<h2 id="sqlc-generate-は何をしているのか"><code>sqlc generate</code> は何をしているのか</h2>
<p>ここから本題に入る。sqlc でコードを生成する generate コマンドが何をしているのか、愚直に最初から処理を辿っていく。</p>
<h3 id="エントリーポイント">エントリーポイント</h3>
<p>sqlc の <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/cmd/sqlc/main.go#L10">main.go</a> は次のようになっている。<code>sqlc generate</code> を実行すると cmd.Do の 1 つ目の引数として <code>["generate"]</code> が渡される。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">os</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">	"</span><span style="color:#B392F0">github.com/sqlc-dev/sqlc/internal/cmd</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	os.</span><span style="color:#B392F0">Exit</span><span style="color:#E1E4E8">(cmd.</span><span style="color:#B392F0">Do</span><span style="color:#E1E4E8">(os.Args[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">:], os.Stdin, os.Stdout, os.Stderr))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="コマンドの実行に関する設定">コマンドの実行に関する設定</h3>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/cmd.go#L35">internal/cmd の Do 関数</a> では、コマンドラインインターフェイスを作成するための外部パッケージとして <a href="https://github.com/spf13/cobra">Cobra</a> を使っている。Go は標準パッケージ <a href="https://pkg.go.dev/flag">flag</a> を使うことで CLI を作れるが、Cobra を使うとサブコマンド（例えば <code>git add</code> や <code>git commit</code> のような階層的なコマンド）を簡単に作れるというメリットがある。</p>
<p>Do 関数を見ていく（コメントは筆者が挿入した）。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> Do</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">stdin</span><span style="color:#B392F0"> io</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Reader</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">stdout</span><span style="color:#B392F0"> io</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Writer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">stderr</span><span style="color:#B392F0"> io</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Writer</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ルートコマンドを初期化する</span></span>
<span class="line"><span style="color:#6A737D">  // "git commit" における "git"</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd </span><span style="color:#F97583">:=</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">cobra</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Command</span><span style="color:#E1E4E8">{Use: </span><span style="color:#9ECBFF">"sqlc"</span><span style="color:#E1E4E8">, SilenceUsage: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D">  // 全てのコマンドで使用されるコマンドラインオプションを追加する</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">PersistentFlags</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">StringP</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"file"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"f"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"specify an alternate config file (default: sqlc.yaml)"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">  // ...省略...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // サブコマンドを追加する</span></span>
<span class="line"><span style="color:#6A737D">  // "git commit" における "commit"</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">AddCommand</span><span style="color:#E1E4E8">(checkCmd)</span></span>
<span class="line"><span style="color:#6A737D">  // ...省略...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ルートコマンドに対して引数, 入力, 出力, エラー出力を追加する</span></span>
<span class="line"><span style="color:#6A737D">  // args, stdin, stdout, stderr は Do 関数の引数として受け取ったものをそのまま渡している</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">SetArgs</span><span style="color:#E1E4E8">(args)</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">SetIn</span><span style="color:#E1E4E8">(stdin)</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">SetOut</span><span style="color:#E1E4E8">(stdout)</span></span>
<span class="line"><span style="color:#E1E4E8">	rootCmd.</span><span style="color:#B392F0">SetErr</span><span style="color:#E1E4E8">(stderr)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	ctx </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> context.</span><span style="color:#B392F0">Background</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">  // デバッグ用のトレースを初期化する</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> debug.Debug.Trace </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		tracectx, cleanup, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> tracer.</span><span style="color:#B392F0">Start</span><span style="color:#E1E4E8">(ctx)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			fmt.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"failed to start trace: </span><span style="color:#79B8FF">%v\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		ctx </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tracectx</span></span>
<span class="line"><span style="color:#F97583">		defer</span><span style="color:#B392F0"> cleanup</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#6A737D">  // コマンドを実行する</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> rootCmd.</span><span style="color:#B392F0">ExecuteContext</span><span style="color:#E1E4E8">(ctx); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> exitError, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> err.(</span><span style="color:#F97583">*</span><span style="color:#B392F0">exec</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">ExitError</span><span style="color:#E1E4E8">); ok {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#E1E4E8"> exitError.</span><span style="color:#B392F0">ExitCode</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">		} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="generate-コマンドの実装">generate コマンドの実装</h3>
<p><code>sqlc generate</code> すると上記の <code>ExecuteContext(ctx)</code> の箇所で <code>genCmd</code> が呼ばれるので、次は genCmd がどのように定義されているかを見てみる。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/cmd.go#L189">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/cmd.go#L189</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> genCmd </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">cobra</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Command</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">	Use:   </span><span style="color:#9ECBFF">"generate"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">	Short: </span><span style="color:#9ECBFF">"Generate Go code from SQL"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">	RunE: </span><span style="color:#F97583">func</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cmd</span><span style="color:#F97583"> *</span><span style="color:#B392F0">cobra</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Command</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		defer</span><span style="color:#E1E4E8"> trace.</span><span style="color:#B392F0">StartRegion</span><span style="color:#E1E4E8">(cmd.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"generate"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">		stderr </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> cmd.</span><span style="color:#B392F0">ErrOrStderr</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">		dir, name </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> getConfigPath</span><span style="color:#E1E4E8">(stderr, cmd.</span><span style="color:#B392F0">Flag</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"file"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">		output, err </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> Generate</span><span style="color:#E1E4E8">(cmd.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">(), </span><span style="color:#B392F0">ParseEnv</span><span style="color:#E1E4E8">(cmd), dir, name, stderr)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			os.</span><span style="color:#B392F0">Exit</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		defer</span><span style="color:#E1E4E8"> trace.</span><span style="color:#B392F0">StartRegion</span><span style="color:#E1E4E8">(cmd.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"writefiles"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">		for</span><span style="color:#E1E4E8"> filename, source </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> output {</span></span>
<span class="line"><span style="color:#E1E4E8">			os.</span><span style="color:#B392F0">MkdirAll</span><span style="color:#E1E4E8">(filepath.</span><span style="color:#B392F0">Dir</span><span style="color:#E1E4E8">(filename), </span><span style="color:#79B8FF">0755</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> os.</span><span style="color:#B392F0">WriteFile</span><span style="color:#E1E4E8">(filename, []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">(source), </span><span style="color:#79B8FF">0644</span><span style="color:#E1E4E8">); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">				fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, filename, err)</span></span>
<span class="line"><span style="color:#F97583">				return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">	},</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>8 行目の Generate 関数で出力を生成しているようなので、次は Generate 関数を見ていく。</p>
<h3 id="generate-関数の実装">Generate 関数の実装</h3>
<p>Generate 関数は <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L131">internal/cmd/generate.go</a> で定義されている。長い関数なので、少しずつ分割しながら読む。</p>
<h4 id="設定ファイルを読む">設定ファイルを読む</h4>
<p>まずは readConfig で設定ファイルを読み込む。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L132">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L132</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">	configPath, conf, err </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> readConfig</span><span style="color:#E1E4E8">(stderr, dir, filename)</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	base </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> filepath.</span><span style="color:#B392F0">Base</span><span style="color:#E1E4E8">(configPath)</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> config.</span><span style="color:#B392F0">Validate</span><span style="color:#E1E4E8">(conf); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"error validating </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, base, err)</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> e.</span><span style="color:#B392F0">Validate</span><span style="color:#E1E4E8">(conf); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"error validating </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, base, err)</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L74">readConfig</a> では <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/config/config.go#L189">ParseConfig</a> を呼ぶことで version ごとに別の関数を呼び出している。</p>
<p>v2 の場合は v2ParseConfig が呼ばれる。v2ParseConfig では io.Reader から入力として設定を読み込み、それを Config 型のインスタンスとして YAML をデコードして解析する。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/config/v_two.go#L11">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/config/v_two.go#L11</a></p>
<h4 id="リモート生成">リモート生成</h4>
<p>コードのリモート生成が設定で有効にされている場合は <code>remoteGenerate</code> を呼び出す。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L148">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L148</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> conf.Cloud.Project </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> ""</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">e.NoRemote {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#B392F0"> remoteGenerate</span><span style="color:#E1E4E8">(ctx, configPath, conf, dir, stderr)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<p>remoteGenerate の実装は以下のようになっている。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L270">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L270</a></p>
<p>この関数はリモートのサービスにリクエストを送信して生成されたコードを受け取るためのクライアント側の処理で、日常的に使うことは少ないかもしれない。詳細は <a href="https://github.com/sqlc-dev/sqlc/discussions/2234">Discussions #2234</a> を参照。sqlc は将来的にこれで収益化するつもりなのかもしれない。</p>
<h4 id="出力の準備">出力の準備</h4>
<p>最終的に出力する output <code>map[string]string{}</code> とそれを作るための pairs <code>[]outPair</code> を作る。pairs にはどのようなコード（例えば Go）を生成するか、どのプラグインを使って生成するか設定を追加していく。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L152-L176">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L152-L176</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">	output </span><span style="color:#F97583">:=</span><span style="color:#F97583"> map</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#E1E4E8">	errored </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> pairs []</span><span style="color:#B392F0">outPair</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> _, sql </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> conf.SQL {</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> sql.Gen.Go </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			pairs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(pairs, </span><span style="color:#B392F0">outPair</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				SQL: sql,</span></span>
<span class="line"><span style="color:#E1E4E8">				Gen: </span><span style="color:#B392F0">config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SQLGen</span><span style="color:#E1E4E8">{Go: sql.Gen.Go},</span></span>
<span class="line"><span style="color:#E1E4E8">			})</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> sql.Gen.JSON </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			pairs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(pairs, </span><span style="color:#B392F0">outPair</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				SQL: sql,</span></span>
<span class="line"><span style="color:#E1E4E8">				Gen: </span><span style="color:#B392F0">config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SQLGen</span><span style="color:#E1E4E8">{JSON: sql.Gen.JSON},</span></span>
<span class="line"><span style="color:#E1E4E8">			})</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		for</span><span style="color:#E1E4E8"> i, _ </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> sql.Codegen {</span></span>
<span class="line"><span style="color:#E1E4E8">			pairs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(pairs, </span><span style="color:#B392F0">outPair</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				SQL:    sql,</span></span>
<span class="line"><span style="color:#E1E4E8">				Plugin: </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">sql.Codegen[i],</span></span>
<span class="line"><span style="color:#E1E4E8">			})</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<p>例えば以下のような sqlc.yaml で generate する場合を考える。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#85E89D">version</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"2"</span></span>
<span class="line"><span style="color:#85E89D">sql</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">engine</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"postgresql"</span></span>
<span class="line"><span style="color:#85E89D">    queries</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./database/queries/queries.sql"</span></span>
<span class="line"><span style="color:#85E89D">    schema</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"/database/schema/schema.sql"</span></span>
<span class="line"><span style="color:#85E89D">    gen</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      go</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        package</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"tutorial"</span></span>
<span class="line"><span style="color:#85E89D">        out</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./generated"</span></span></code></pre>
<p><code>sql.Gen.Go != nil</code> なので pairs に下記の outPair が追加される。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">outPair</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">	SQL: sql,</span></span>
<span class="line"><span style="color:#E1E4E8">	Gen: </span><span style="color:#B392F0">config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SQLGen</span><span style="color:#E1E4E8">{Go: sql.Gen.Go},</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>ここで追加した outPair は次の「並列処理の準備」のさらに次の「コードの生成」の箇所でイテレーションに使われる。</p>
<h4 id="並列処理の準備">並列処理の準備</h4>
<p>同時実行に関する Mutex を初期化する。出力の書き込み時に競合を避けるために使う。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L177-L182">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L177-L182</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> m </span><span style="color:#B392F0">sync</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Mutex</span></span>
<span class="line"><span style="color:#E1E4E8">	grp, gctx </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> errgroup.</span><span style="color:#B392F0">WithContext</span><span style="color:#E1E4E8">(ctx)</span></span>
<span class="line"><span style="color:#E1E4E8">	grp.</span><span style="color:#B392F0">SetLimit</span><span style="color:#E1E4E8">(runtime.</span><span style="color:#B392F0">GOMAXPROCS</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	stderrs </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#B392F0">bytes</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Buffer</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(pairs))</span></span></code></pre>
<h4 id="コードの生成">コードの生成</h4>
<p>pairs スライスに格納された出力ペアをイテレートし、それぞれのペアについて SQL の解析（<code>parse</code>）とコード生成（<code>codegen</code>）の処理を非同期的に並列実行していく。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L183-L255">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L183-L255</a></p>
<p><code>// TODO: </code> 以外のコメントは筆者が挿入した。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">  // ↑ で作った pairs をイテレートしていく</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> i, pair </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> pairs {</span></span>
<span class="line"><span style="color:#6A737D">    // 現在の pair を格納する</span></span>
<span class="line"><span style="color:#E1E4E8">		sql </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> pair</span></span>
<span class="line"><span style="color:#E1E4E8">		errout </span><span style="color:#F97583">:=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">stderrs[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 新しい goroutine を起動して非同期的に各ペアの処理を実行する</span></span>
<span class="line"><span style="color:#E1E4E8">		grp.</span><span style="color:#B392F0">Go</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">func</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // 全体の設定と現在の pair に入っている SQL オプションを結合する</span></span>
<span class="line"><span style="color:#E1E4E8">			combo </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> config.</span><span style="color:#B392F0">Combine</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">conf, sql.SQL)</span></span>
<span class="line"><span style="color:#6A737D">      // プラグインの設定があれば追加する</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> sql.Plugin </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">				combo.Codegen </span><span style="color:#F97583">=</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">sql.Plugin</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">			// TODO: This feels like a hack that will bite us later</span></span>
<span class="line"><span style="color:#E1E4E8">			joined </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(sql.Schema))</span></span>
<span class="line"><span style="color:#6A737D">      // スキーマが書かれた SQL ファイルのパスを設定に追加する</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> _, s </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> sql.Schema {</span></span>
<span class="line"><span style="color:#E1E4E8">				joined </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(joined, filepath.</span><span style="color:#B392F0">Join</span><span style="color:#E1E4E8">(dir, s))</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">			sql.Schema </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> joined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">			joined </span><span style="color:#F97583">=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(sql.Queries))</span></span>
<span class="line"><span style="color:#6A737D">      // クエリが書かれた SQL ファイルのパスを設定に追加する</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> _, q </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> sql.Queries {</span></span>
<span class="line"><span style="color:#E1E4E8">				joined </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(joined, filepath.</span><span style="color:#B392F0">Join</span><span style="color:#E1E4E8">(dir, q))</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">			sql.Queries </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> joined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">			var</span><span style="color:#E1E4E8"> name, lang </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">			parseOpts </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> opts</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Parser</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				Debug: debug.Debug,</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // Go かプラグインかに応じて、名前を設定する</span></span>
<span class="line"><span style="color:#F97583">			switch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			case</span><span style="color:#E1E4E8"> sql.Gen.Go </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">				name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> combo.Go.Package</span></span>
<span class="line"><span style="color:#E1E4E8">				lang </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "golang"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">			case</span><span style="color:#E1E4E8"> sql.Plugin </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">				lang </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"process:</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, sql.Plugin.Plugin)</span></span>
<span class="line"><span style="color:#E1E4E8">				name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sql.Plugin.Plugin</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // この pair の処理をモニタリングする</span></span>
<span class="line"><span style="color:#E1E4E8">			packageRegion </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> trace.</span><span style="color:#B392F0">StartRegion</span><span style="color:#E1E4E8">(gctx, </span><span style="color:#9ECBFF">"package"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">			trace.</span><span style="color:#B392F0">Logf</span><span style="color:#E1E4E8">(gctx, </span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"name=</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> dir=</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> plugin=</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name, dir, lang)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // parse: SQL を解析する</span></span>
<span class="line"><span style="color:#E1E4E8">			result, failed </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> parse</span><span style="color:#E1E4E8">(gctx, name, dir, sql.SQL, combo, parseOpts, errout)</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> failed {</span></span>
<span class="line"><span style="color:#E1E4E8">				packageRegion.</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">				errored </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#F97583">				return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // codegen: コードを生成する</span></span>
<span class="line"><span style="color:#E1E4E8">			out, resp, err </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> codegen</span><span style="color:#E1E4E8">(gctx, combo, sql, result)</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">				fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(errout, </span><span style="color:#9ECBFF">"# package </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#E1E4E8">				fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(errout, </span><span style="color:#9ECBFF">"error generating code: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">				errored </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">				packageRegion.</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">				return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">			files </span><span style="color:#F97583">:=</span><span style="color:#F97583"> map</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">{}</span></span>
<span class="line"><span style="color:#6A737D">      // 生成されたコードを files マップに書き込む</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> _, file </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> resp.Files {</span></span>
<span class="line"><span style="color:#E1E4E8">				files[file.Name] </span><span style="color:#F97583">=</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">(file.Contents)</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // グローバルな output マップに生成されたコードを追加する</span></span>
<span class="line"><span style="color:#6A737D">      // 他の goroutine との競合を避けるために Mutex を使用する</span></span>
<span class="line"><span style="color:#E1E4E8">			m.</span><span style="color:#B392F0">Lock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> n, source </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> files {</span></span>
<span class="line"><span style="color:#E1E4E8">				filename </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> filepath.</span><span style="color:#B392F0">Join</span><span style="color:#E1E4E8">(dir, out, n)</span></span>
<span class="line"><span style="color:#E1E4E8">				output[filename] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> source</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">			m.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">			packageRegion.</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">		})</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<p>SQL の解析とコードの生成のロジックはそれぞれ <code>parse</code> 関数と <code>codegen</code> 関数に記述されているので、詳しく見ていく。</p>
<h4 id="sql-の解析">SQL の解析</h4>
<p>parse 関数を見ていく。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L333-L362">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L333-L362</a></p>
<p>コメントは筆者が挿入した。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> parse</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">name</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">dir</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">sql</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">SQL</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">combo</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">CombinedSettings</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">parserOpts</span><span style="color:#B392F0"> opts</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Parser</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">stderr</span><span style="color:#B392F0"> io</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Writer</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">compiler</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">	defer</span><span style="color:#E1E4E8"> trace.</span><span style="color:#B392F0">StartRegion</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#9ECBFF">"parse"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">  // SQL を解析するためのコンパイラを初期化する</span></span>
<span class="line"><span style="color:#6A737D">  // sql.Engine によって使用する parser/catalog が変わる</span></span>
<span class="line"><span style="color:#E1E4E8">	c </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> compiler.</span><span style="color:#B392F0">NewCompiler</span><span style="color:#E1E4E8">(sql, combo)</span></span>
<span class="line"><span style="color:#6A737D">  // スキーマの SQL を解析する</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">ParseCatalog</span><span style="color:#E1E4E8">(sql.Schema); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"# package </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> parserErr, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> err.(</span><span style="color:#F97583">*</span><span style="color:#B392F0">multierr</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">); ok {</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> _, fileErr </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> parserErr.</span><span style="color:#B392F0">Errs</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">				printFileErr</span><span style="color:#E1E4E8">(stderr, dir, fileErr)</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"error parsing schema: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> parserOpts.Debug.DumpCatalog {</span></span>
<span class="line"><span style="color:#E1E4E8">		debug.</span><span style="color:#B392F0">Dump</span><span style="color:#E1E4E8">(c.</span><span style="color:#B392F0">Catalog</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#6A737D">  // クエリの SQL を解析する</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">ParseQueries</span><span style="color:#E1E4E8">(sql.Queries, parserOpts); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"# package </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> parserErr, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> err.(</span><span style="color:#F97583">*</span><span style="color:#B392F0">multierr</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">); ok {</span></span>
<span class="line"><span style="color:#F97583">			for</span><span style="color:#E1E4E8"> _, fileErr </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> parserErr.</span><span style="color:#B392F0">Errs</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">				printFileErr</span><span style="color:#E1E4E8">(stderr, dir, fileErr)</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			fmt.</span><span style="color:#B392F0">Fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"error parsing queries: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">(), </span><span style="color:#79B8FF">false</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h5 id="parse-について">Parse について</h5>
<p>クエリの形式はデータベースエンジンによって異なる。PostgreSQL 関連の処理は <a href="https://github.com/sqlc-dev/sqlc/tree/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/engine/postgresql">/internal/engine/postgresql</a> 以下で internal の postgresql パッケージとして定義されている。</p>
<p>ParseCatalog や ParseQueries では <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/engine/postgresql/parse.go#L152">/internal/engine/postgresql/parse.go</a> で定義されている Parse 関数が呼ばれるので、それを読んでみる。</p>
<p>コメントは筆者が挿入した。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">p </span><span style="color:#F97583">*</span><span style="color:#B392F0">Parser</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">Parse</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">r</span><span style="color:#B392F0"> io</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Reader</span><span style="color:#E1E4E8">) ([]</span><span style="color:#B392F0">ast</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Statement</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // ここで SQL のスキーマやクエリを受け取る</span></span>
<span class="line"><span style="color:#E1E4E8">	contents, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> io.</span><span style="color:#B392F0">ReadAll</span><span style="color:#E1E4E8">(r)</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#6A737D">  // SQL を解析して Parse tree を構築する</span></span>
<span class="line"><span style="color:#6A737D">  // nodes.Parse による解析では github.com/pganalyze/pg_query_go/v4 を使っている</span></span>
<span class="line"><span style="color:#6A737D">  // これにより解析結果の tree を得るので、後で最終的に Go のコードに変換するための AST に渡す</span></span>
<span class="line"><span style="color:#E1E4E8">	tree, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> nodes.</span><span style="color:#B392F0">Parse</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">(contents))</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		pErr </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> normalizeErr</span><span style="color:#E1E4E8">(err)</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, pErr</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> stmts []</span><span style="color:#B392F0">ast</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Statement</span></span>
<span class="line"><span style="color:#6A737D">  // 解析した SQL の各ステートメントに対してイテレートする</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> _, raw </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> tree.Stmts {</span></span>
<span class="line"><span style="color:#6A737D">    // translate 関数で sqlc がコードを生成するための AST を構築する</span></span>
<span class="line"><span style="color:#E1E4E8">		n, err </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> translate</span><span style="color:#E1E4E8">(raw.Stmt)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> errSkip {</span></span>
<span class="line"><span style="color:#F97583">			continue</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"unexpected nil node"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		stmts </span><span style="color:#F97583">=</span><span style="color:#B392F0"> append</span><span style="color:#E1E4E8">(stmts, </span><span style="color:#B392F0">ast</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Statement</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">			Raw: </span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">ast</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">RawStmt</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				Stmt:         n,</span></span>
<span class="line"><span style="color:#E1E4E8">				StmtLocation: </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(raw.StmtLocation),</span></span>
<span class="line"><span style="color:#E1E4E8">				StmtLen:      </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(raw.StmtLen),</span></span>
<span class="line"><span style="color:#E1E4E8">			},</span></span>
<span class="line"><span style="color:#E1E4E8">		})</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> stmts, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/engine/postgresql/parse.go#L209">translate 関数</a>は非常に長いので読むのが大変だが、基本的には pganalyze/pg_query_go を使って解析された PostgreSQL のノードを sqlc 内の処理で使う AST に変換する責務を負っていると考えてよい。</p>
<p>sqlc 内の処理で使う AST は <a href="https://github.com/sqlc-dev/sqlc/tree/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/sql/ast">internal/sql/ast</a> 以下に定義されている。</p>
<h5 id="parsecatalog-について">ParseCatalog について</h5>
<p>Catalog はクエリを解析するために持つデータを集めた sqlc の内部的なデータ構造。PostgreSQL、MySQL、SQLite などデータベースエンジンごとに異なる Catalog を持つ。</p>
<p>PostgreSQL のスキーマ解析に使われる Catalog を生成する関数は以下で定義されている。引用はしないが、行数がすごいので一度見てみて欲しい。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/engine/postgresql/pg_catalog.go#L30178">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/engine/postgresql/pg_catalog.go#L30178</a></p>
<p>Catalog では SQL から AST を構築するにあたり <a href="https://github.com/sqlc-dev/sqlc/tree/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/sql/ast">internal/sql/ast</a> 以下に列挙されている SQL 文を表す構造体を使用する。例えば CREATE TABLE 文は <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/sql/ast/create_table_stmt.go">crate_table_stmt.go</a> で以下のように定義されている。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> ast</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> CreateTableStmt</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	IfNotExists </span><span style="color:#F97583">bool</span></span>
<span class="line"><span style="color:#E1E4E8">	Name        </span><span style="color:#F97583">*</span><span style="color:#B392F0">TableName</span></span>
<span class="line"><span style="color:#E1E4E8">	Cols        []</span><span style="color:#F97583">*</span><span style="color:#B392F0">ColumnDef</span></span>
<span class="line"><span style="color:#E1E4E8">	ReferTable  </span><span style="color:#F97583">*</span><span style="color:#B392F0">TableName</span></span>
<span class="line"><span style="color:#E1E4E8">	Comment     </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">	Inherits    []</span><span style="color:#F97583">*</span><span style="color:#B392F0">TableName</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">n </span><span style="color:#F97583">*</span><span style="color:#B392F0">CreateTableStmt</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">Pos</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>例えば CREATE TABLE 文で使われる <code>IF NOT EXISTS</code> は <code>IfNotExists</code> として構造体のメンバーとして定義されている。pganalyze/pg_query_go の処理結果として取得した node を translate 関数でこれらの構造体にマッピングして sqlc 内でコードを生成するための AST に変換する。</p>
<h5 id="parsequeries-について">ParseQueries について</h5>
<p>catalog と同様 SQL 文を表す構造体は <a href="https://github.com/sqlc-dev/sqlc/tree/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/sql/ast">internal/sql/ast</a> に格納されている。例えば SELECT 文は <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/sql/ast/select_stmt.go">select_stmt.go</a> で以下のように定義されている。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> ast</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> SelectStmt</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	DistinctClause </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	IntoClause     </span><span style="color:#F97583">*</span><span style="color:#B392F0">IntoClause</span></span>
<span class="line"><span style="color:#E1E4E8">	TargetList     </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	FromClause     </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	WhereClause    </span><span style="color:#B392F0">Node</span></span>
<span class="line"><span style="color:#E1E4E8">	GroupClause    </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	HavingClause   </span><span style="color:#B392F0">Node</span></span>
<span class="line"><span style="color:#E1E4E8">	WindowClause   </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	ValuesLists    </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	SortClause     </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	LimitOffset    </span><span style="color:#B392F0">Node</span></span>
<span class="line"><span style="color:#E1E4E8">	LimitCount     </span><span style="color:#B392F0">Node</span></span>
<span class="line"><span style="color:#E1E4E8">	LockingClause  </span><span style="color:#F97583">*</span><span style="color:#B392F0">List</span></span>
<span class="line"><span style="color:#E1E4E8">	WithClause     </span><span style="color:#F97583">*</span><span style="color:#B392F0">WithClause</span></span>
<span class="line"><span style="color:#E1E4E8">	Op             </span><span style="color:#B392F0">SetOperation</span></span>
<span class="line"><span style="color:#E1E4E8">	All            </span><span style="color:#F97583">bool</span></span>
<span class="line"><span style="color:#E1E4E8">	Larg           </span><span style="color:#F97583">*</span><span style="color:#B392F0">SelectStmt</span></span>
<span class="line"><span style="color:#E1E4E8">	Rarg           </span><span style="color:#F97583">*</span><span style="color:#B392F0">SelectStmt</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">n </span><span style="color:#F97583">*</span><span style="color:#B392F0">SelectStmt</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">Pos</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>SELECT 文（Stmt は Statement の略？）で使われる <code>DISTINCT</code> や <code>GROUP BY</code>、<code>ORDER BY</code> などが構造体のメンバーとして定義されている。</p>
<h4 id="コードの生成-1">コードの生成</h4>
<p>次は codegen 関数を見ていく。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L364-L412">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L364-L412</a></p>
<p>コメントは筆者が挿入した。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> codegen</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ctx</span><span style="color:#B392F0"> context</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Context</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">combo</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">CombinedSettings</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">sql</span><span style="color:#B392F0"> outPair</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">result</span><span style="color:#F97583"> *</span><span style="color:#B392F0">compiler</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">*</span><span style="color:#B392F0">plugin</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">CodeGenResponse</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // デバッグ用のトレースを設定する</span></span>
<span class="line"><span style="color:#F97583">	defer</span><span style="color:#E1E4E8"> trace.</span><span style="color:#B392F0">StartRegion</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#9ECBFF">"codegen"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">End</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">  // Catalog などの設定を req オブジェクトにまとめる</span></span>
<span class="line"><span style="color:#E1E4E8">	req </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> codeGenRequest</span><span style="color:#E1E4E8">(result, combo)</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> handler </span><span style="color:#B392F0">ext</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Handler</span></span>
<span class="line"><span style="color:#F97583">	var</span><span style="color:#E1E4E8"> out </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#6A737D">  // どの言語、方式でコード生成するかを選択する</span></span>
<span class="line"><span style="color:#F97583">	switch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	case</span><span style="color:#E1E4E8"> sql.Gen.Go </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">		out </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> combo.Go.Out</span></span>
<span class="line"><span style="color:#E1E4E8">		handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext.</span><span style="color:#B392F0">HandleFunc</span><span style="color:#E1E4E8">(golang.Generate)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	case</span><span style="color:#E1E4E8"> sql.Gen.JSON </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">		out </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> combo.JSON.Out</span></span>
<span class="line"><span style="color:#E1E4E8">		handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext.</span><span style="color:#B392F0">HandleFunc</span><span style="color:#E1E4E8">(json.Generate)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	case</span><span style="color:#E1E4E8"> sql.Plugin </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">		out </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sql.Plugin.Out</span></span>
<span class="line"><span style="color:#E1E4E8">		plug, err </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> findPlugin</span><span style="color:#E1E4E8">(combo.Global, sql.Plugin.Plugin)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"plugin not found: </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // プラグインでコード生成する場合は Process か WASM かによってハンドラを設定する</span></span>
<span class="line"><span style="color:#F97583">		switch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		case</span><span style="color:#E1E4E8"> plug.Process </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">			handler </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">process</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Runner</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				Cmd: plug.Process.Cmd,</span></span>
<span class="line"><span style="color:#E1E4E8">				Env: plug.Env,</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#F97583">		case</span><span style="color:#E1E4E8"> plug.WASM </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">			handler </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">wasm</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Runner</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">				URL:    plug.WASM.URL,</span></span>
<span class="line"><span style="color:#E1E4E8">				SHA256: plug.WASM.SHA256,</span></span>
<span class="line"><span style="color:#E1E4E8">				Env:    plug.Env,</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#F97583">		default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"unsupported plugin type"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // プラグインのオプションを JSON 形式に変換する</span></span>
<span class="line"><span style="color:#E1E4E8">		opts, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> convert.</span><span style="color:#B392F0">YAMLtoJSON</span><span style="color:#E1E4E8">(sql.Plugin.Options)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"invalid plugin options"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		req.PluginOptions </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> opts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"missing language backend"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#6A737D">  // 選択したハンドラを使用してコードを生成する</span></span>
<span class="line"><span style="color:#E1E4E8">	resp, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> handler.</span><span style="color:#B392F0">Generate</span><span style="color:#E1E4E8">(ctx, req)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> out, resp, err</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>最後に handler.Generate で呼び出される関数は handler の設定によって異なる。Go ではこの Generate 関数が呼ばれる。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/codegen/golang/gen.go#L104">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/codegen/golang/gen.go#L104</a></p>
<p>上記の Generate 関数が呼ぶ <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/codegen/golang/gen.go#L119">generate 関数</a>では <a href="https://pkg.go.dev/text/template">text/template</a> で template からファイルを生成する。Go 版は <a href="https://github.com/sqlc-dev/sqlc/tree/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/codegen/golang/templates">/internal/codegen/golang/templates</a> 以下に書かれており、<a href="https://pkg.go.dev/embed">embed</a> パッケージを使って埋め込まれている。</p>
<p>デフォルトのテンプレートは <a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/codegen/golang/templates/template.tmpl">/internal/codegen/golang/templatess/template.tmpl</a> で、これを見ると sqlc が生成する .go ファイルに酷似していることが分かる。</p>
<p>最終的には <a href="https://pkg.go.dev/text/template#Template.ExecuteTemplate">ExecuteTemplate</a> を使ってデータ（&#x26;tctx）を templateName のテンプレートを介して bufio に書き込んでいる。</p>
<p>コメントは筆者が挿入した。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">	execute </span><span style="color:#F97583">:=</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">name</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">templateName</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		imports </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> i.</span><span style="color:#B392F0">Imports</span><span style="color:#E1E4E8">(name)</span></span>
<span class="line"><span style="color:#E1E4E8">		replacedQueries </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> replaceConflictedArg</span><span style="color:#E1E4E8">(imports, queries)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">		var</span><span style="color:#E1E4E8"> b </span><span style="color:#B392F0">bytes</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Buffer</span></span>
<span class="line"><span style="color:#E1E4E8">		w </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> bufio.</span><span style="color:#B392F0">NewWriter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">b)</span></span>
<span class="line"><span style="color:#E1E4E8">		tctx.SourceName </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> name</span></span>
<span class="line"><span style="color:#E1E4E8">		tctx.GoQueries </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> replacedQueries</span></span>
<span class="line"><span style="color:#E1E4E8">		err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> tmpl.</span><span style="color:#B392F0">ExecuteTemplate</span><span style="color:#E1E4E8">(w, templateName, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">tctx) </span><span style="color:#6A737D">// ここでテンプレートに沿ってテキストを生成し w を介して bufio に書き込んでいる</span></span>
<span class="line"><span style="color:#E1E4E8">		w.</span><span style="color:#B392F0">Flush</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		code, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> format.</span><span style="color:#B392F0">Source</span><span style="color:#E1E4E8">(b.</span><span style="color:#B392F0">Bytes</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			fmt.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(b.</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#E1E4E8"> fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"source error: </span><span style="color:#79B8FF">%w</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> templateName </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> "queryFile"</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> golang.OutputFilesSuffix </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> ""</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			name </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> golang.OutputFilesSuffix</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">strings.</span><span style="color:#B392F0">HasSuffix</span><span style="color:#E1E4E8">(name, </span><span style="color:#9ECBFF">".go"</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">			name </span><span style="color:#F97583">+=</span><span style="color:#9ECBFF"> ".go"</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		output[name] </span><span style="color:#F97583">=</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">(code)</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span></code></pre>
<h4 id="エラーの処理と生成されたコードの返却">エラーの処理と生成されたコードの返却</h4>
<p>最後はエラー処理して output を返すだけ。</p>
<p><a href="https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L256-L267">https://github.com/sqlc-dev/sqlc/blob/faa1c9d156272eea4d33a31de2ab94951ba6af58/internal/cmd/generate.go#L256-L267</a></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> grp.</span><span style="color:#B392F0">Wait</span><span style="color:#E1E4E8">(); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> errored {</span></span>
<span class="line"><span style="color:#F97583">		for</span><span style="color:#E1E4E8"> i, _ </span><span style="color:#F97583">:=</span><span style="color:#F97583"> range</span><span style="color:#E1E4E8"> stderrs {</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> io.</span><span style="color:#B392F0">Copy</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">stderrs[i]); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">				return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, fmt.</span><span style="color:#B392F0">Errorf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"errored"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> output, </span><span style="color:#79B8FF">nil</span></span></code></pre>
<h2 id="まとめ">まとめ</h2>
<p>私自身まだ使い始めたばかりで把握していないことが多く自分自身が Go 初心者でもあるので、誤った認識や不足している記述があるかもしれない（あったらすみません）。</p>
<p>これから使っていく中で面白いことがあればまたブログに書いてみようと考えている。</p>
<h3 id="sqlc">sqlc</h3>
<ul>
<li>SQL ファイルから型安全な Go のデータベースクライアントやスキーマと対応した構造体を簡単に生成できて便利</li>
<li>生成されるファイルを設定ファイルやプラグイン等で加工することができる</li>
</ul>
<p>sqlc の導入については公式ドキュメントの他に以下のブログが参考になりそう。</p>
<ul>
<li><a href="https://future-architect.github.io/articles/20221128a/">業務システム開発で sqlc を導入して良かった点とハマった点 - フューチャー技術ブログ</a></li>
</ul>
<p>プラグインについては以下のブログが参考になりそう。</p>
<ul>
<li><a href="https://orisano.hatenablog.com/entry/2023/09/06/010926">sqlc plugin を書こう - 薄いブログ</a></li>
</ul>
<h3 id="sqlc-generate-コマンド">sqlc generate コマンド</h3>
<ul>
<li>SQL ファイルからの生成は SQL の句ごと、データベースエンジン別に AST を組み立てるための Go の構造体が用意されており、それを参照して SQL を解析する</li>
<li>コードの生成は予め template が用意され embed されており、text/template を使ってデータを流し込む</li>
</ul>
<hr>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>Go 以外にも Kotlin や Python 等がサポートされている <a href="https://docs.sqlc.dev/en/stable/reference/language-support.html">https://docs.sqlc.dev/en/stable/reference/language-support.html</a> <a href="#user-content-fnref-1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Ryohei Tsuda. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/rtsudal" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow me on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/lyohe" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to my GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>